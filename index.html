<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Recipe Book</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#3F4B3B">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        granite: '#3F4B3B', // Reverted to original
                        deepmoss: '#2A3327', // New darker green
                        sand: '#A49966',
                        drysage: '#C7C7A6',
                        frostedmint: '#EAFFDA',
                        darkraspberry: '#861657',
                    }
                }
            }
        }
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bree+Serif&family=Pacifico&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #2A3327;
            /* Clearer Fern Pattern with higher opacity */
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M30 60 L30 0 M30 50 L55 40 M30 50 L5 40 M30 35 L55 25 M30 35 L5 25 M30 20 L55 10 M30 20 L5 10' stroke='%233F4B3B' stroke-width='2' stroke-linecap='round' fill='none' opacity='0.4'/%3E%3C/svg%3E");
            background-size: 60px 60px;
            background-attachment: fixed;
        }
        .font-serif { font-family: 'Bree Serif', serif; }
        .font-pacifico { font-family: 'Pacifico', cursive; }
        .modal.hidden, .page.hidden { display: none; }
        /* Hide scrollbar for Chrome, Safari and Opera */
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        /* Hide scrollbar for IE, Edge and Firefox */
        .scrollbar-hide {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
    </style>
</head>
<body class="text-frostedmint">

    <div class="container mx-auto max-w-6xl px-4 py-12">
        <header class="mb-12 text-center relative">
            <h1 class="text-8xl text-frostedmint font-pacifico tracking-normal">My Recipes</h1>
            <button id="open-settings-btn" class="absolute top-0 right-0 p-2 text-drysage hover:text-sand" title="Connection Settings">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
            </button>
        </header>

        <!-- NAVIGATION -->
        <nav class="flex justify-center mb-8 bg-granite border border-sand p-2 rounded-lg border border-sand">
            <button id="nav-recipes" class="nav-btn bg-sand text-frostedmint px-6 py-2 rounded-md font-semibold font-serif">All Recipes</button>
            <button id="nav-planner" class="nav-btn text-frostedmint hover:text-drysage px-6 py-2 rounded-md font-semibold font-serif">Meal Planner</button>
            <button id="nav-shopping" class="nav-btn text-frostedmint hover:text-drysage px-6 py-2 rounded-md font-semibold font-serif">Shopping List</button>
        </nav>

        <!-- PAGE 1: RECIPES -->
        <div id="page-recipes" class="page max-w-3xl mx-auto">
            <main class="bg-granite border border-sand p-6 sm:p-8 rounded-2xl border border-sand">
                <div class="flex justify-between items-center mb-4">
                     <h2 class="text-4xl text-frostedmint font-pacifico font-normal">All Recipes</h2>
                     <button id="open-add-modal-btn" class="inline-flex items-center gap-2 justify-center rounded-md border border-transparent bg-sand py-2 px-4 text-sm font-medium text-frostedmint shadow-sm hover:opacity-90">
                         <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                         Add New Recipe
                     </button>
                </div>
                <div id="recipes-list" class="flex overflow-x-auto gap-6 p-1 cursor-grab active:cursor-grabbing select-none snap-x scrollbar-hide" style="-ms-overflow-style: none; scrollbar-width: none;"></div>
            </main>
        </div>

        <!-- PAGE 2: MEAL PLANNER -->
        <div id="page-planner" class="page hidden">
            <main class="bg-granite border border-sand p-6 sm:p-8 rounded-2xl border border-sand">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-4xl text-frostedmint font-pacifico font-normal">Meal Plan</h2>
                    <div class="flex gap-2">
                        <button id="clear-plan-btn" class="inline-flex items-center gap-2 justify-center rounded-md border border-sand bg-drysage text-granite placeholder-granite/70 py-2 px-4 text-sm font-medium text-darkraspberry shadow-sm hover:bg-drysage/50">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                            Clear Plan
                        </button>
                        <button id="generate-shopping-btn" class="inline-flex items-center gap-2 justify-center rounded-md border border-transparent bg-sand py-2 px-4 text-sm font-medium text-frostedmint shadow-sm hover:opacity-90">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 3a1 1 0 011-1h12a1 1 0 011 1v3a1 1 0 01-.293.707L12 11.414V15a1 1 0 01-.293.707l-2 2A1 1 0 018 17v-5.586L3.293 6.707A1 1 0 013 6V3z" clip-rule="evenodd" /></svg>
                            Generate List
                        </button>
                    </div>
                </div>
                <div id="meal-plan-grid" class="grid grid-cols-4 gap-1">
                    <!-- Grid will be generated by JS -->
                </div>
            </main>
        </div>
        <!-- PAGE 3: SHOPPING LIST -->
        <div id="page-shopping" class="page hidden max-w-3xl mx-auto">
            <main class="bg-granite border border-sand p-6 sm:p-8 rounded-2xl border border-sand">
                <h2 class="text-4xl text-frostedmint font-pacifico font-normal mb-4">Shopping List</h2>
                <div id="shopping-list-container" class="space-y-2 mb-6">
                    <p class="text-drysage">Your shopping list is empty. Go to the Meal Planner and click "Generate List".</p>
                </div>
                <div class="border-t border-sand pt-4">
                    <h3 class="text-lg font-medium text-frostedmint mb-2">Add Extra Item</h3>
                    <form id="add-shopping-item-form" class="flex gap-2">
                        <input type="text" name="item_name" placeholder="e.g. Milk, Bread" class="flex-1 rounded-md bg-drysage text-granite placeholder-granite/70 border-sand text-frostedmint shadow-sm focus:border-sand focus:ring-sand" required>
                        <button type="submit" class="inline-flex justify-center rounded-md border border-transparent bg-slate-600 py-2 px-4 text-sm font-medium text-frostedmint shadow-sm hover:bg-slate-500">Add</button>
                    </form>
                </div>
            </main>
        </div>
    </div>
    
    <!-- MODALS -->
    <div id="add-modal" class="modal fixed inset-0 bg-black bg-opacity-60 hidden flex items-center justify-center p-4">
        <div class="bg-granite border border-sand rounded-2xl shadow-xl p-6 sm:p-8 w-full max-w-3xl border border-sand">
            <h2 class="text-2xl font-semibold text-frostedmint mb-4">Add a New Recipe</h2>
            <form id="add-recipe-form" class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-4">
                <div class="sm:col-span-2"><label for="add-name" class="block text-sm font-medium text-drysage">Recipe Name</label><input type="text" name="name" id="add-name" required class="mt-1 block w-full rounded-md bg-drysage text-granite placeholder-granite/70 border-sand text-frostedmint shadow-sm focus:border-sand focus:ring-sand"></div>
                <div class="sm:col-span-2">
                    <label class="block text-sm font-medium text-drysage">Recipe Image</label>
                    <div class="mt-1 flex gap-2 items-center">
                        <input type="file" id="add-image-input" accept="image/*" class="block w-full text-sm text-drysage file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-sand file:text-frostedmint hover:file:bg-sand/80">
                        <button type="button" id="add-generate-btn" class="inline-flex items-center justify-center rounded-md border border-sand bg-drysage px-4 py-2 text-sm font-medium text-granite shadow-sm hover:bg-sand hover:text-frostedmint whitespace-nowrap">Generate AI ✨</button>
                    </div>
                    <input type="hidden" name="image_base64" id="add-image-base64">
                    <div id="add-image-preview-container" class="mt-2 hidden relative w-full h-48 bg-granite border border-sand rounded-md overflow-hidden">
                        <img id="add-image-preview" class="w-full h-full object-cover opacity-80">
                        <button type="button" id="add-remove-image" class="absolute top-2 right-2 bg-darkraspberry text-frostedmint rounded-full p-1 shadow-md hover:bg-opacity-80">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                        </button>
                    </div>
                </div>
                <div><label for="add-prep_time" class="block text-sm font-medium text-drysage">Prep Time (mins)</label><input type="number" name="prep_time" id="add-prep_time" class="mt-1 block w-full rounded-md bg-drysage text-granite placeholder-granite/70 border-sand text-frostedmint shadow-sm focus:border-sand focus:ring-sand"></div>
                <div><label for="add-cook_time" class="block text-sm font-medium text-drysage">Cook Time (mins)</label><input type="number" name="cook_time" id="add-cook_time" class="mt-1 block w-full rounded-md bg-drysage text-granite placeholder-granite/70 border-sand text-frostedmint shadow-sm focus:border-sand focus:ring-sand"></div>
                <div class="sm:col-span-2"><label for="add-servings" class="block text-sm font-medium text-drysage">Servings</label><input type="number" name="servings" id="add-servings" class="mt-1 block w-full rounded-md bg-drysage text-granite placeholder-granite/70 border-sand text-frostedmint shadow-sm focus:border-sand focus:ring-sand"></div>
                <div class="sm:col-span-2"><label for="add-instructions" class="block text-sm font-medium text-drysage">Instructions</label><textarea name="instructions" id="add-instructions" rows="6" required class="mt-1 block w-full rounded-md bg-drysage text-granite placeholder-granite/70 border-sand text-frostedmint shadow-sm focus:border-sand focus:ring-sand"></textarea></div>
            </form>
            
            <hr class="my-6 border-sand">
            
            <div class="ingredients-section">
                <h3 class="text-xl font-semibold text-frostedmint mb-4 font-serif">Ingredients</h3>
                <div id="add-ingredients-list" class="space-y-2 mb-4">
                    <p class="text-sm text-sand">No ingredients added yet.</p>
                </div>
                <div id="add-new-ingredient-container" class="grid grid-cols-1 sm:grid-cols-3 gap-4 items-end p-4 bg-granite rounded-lg">
                    <div class="sm:col-span-2">
                        <label for="add-ing-name" class="block text-sm font-medium text-drysage">Ingredient Name</label>
                        <input type="text" id="add-ing-name" placeholder="e.g., Onion" class="mt-1 block w-full rounded-md bg-drysage text-granite placeholder-granite/70 border-sand text-frostedmint shadow-sm focus:border-sand focus:ring-sand">
                    </div>
                    <div>
                        <label for="add-ing-qty" class="block text-sm font-medium text-drysage">Quantity</label>
                        <input type="number" step="any" id="add-ing-qty" placeholder="e.g., 2" class="mt-1 block w-full rounded-md bg-drysage text-granite placeholder-granite/70 border-sand text-frostedmint shadow-sm focus:border-sand focus:ring-sand">
                    </div>
                    <div class="sm:col-span-3 text-right">
                        <button type="button" id="btn-add-ing-to-buffer" class="inline-flex justify-center rounded-md border border-transparent bg-sand py-2 px-4 text-sm font-medium text-frostedmint shadow-sm hover:opacity-90">Add Ingredient</button>
                    </div>
                </div>
            </div>

            <div class="sm:col-span-2 flex justify-end gap-4 mt-8">
                <button type="button" id="cancel-add" class="rounded-md border border-sand bg-drysage text-granite py-2 px-4 text-sm font-medium shadow-sm hover:bg-sand hover:text-frostedmint">Cancel</button>
                <button type="submit" form="add-recipe-form" class="inline-flex justify-center rounded-md border border-transparent bg-sand py-2 px-4 text-sm font-medium text-frostedmint shadow-sm hover:opacity-90">Add Recipe</button>
            </div>
        </div>
    </div>
    <div id="edit-modal" class="modal fixed inset-0 bg-black bg-opacity-60 hidden flex items-start justify-center p-4 overflow-y-auto">
         <div class="bg-granite border border-sand rounded-2xl shadow-xl p-6 sm:p-8 w-full max-w-3xl my-auto border border-sand">
            <h2 class="text-2xl font-semibold text-frostedmint mb-4 font-serif">Edit Recipe</h2>
            <form id="edit-recipe-form"><input type="hidden" name="id" id="edit-id">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-4">
                    <div class="sm:col-span-2"><label for="edit-name" class="block text-sm font-medium text-drysage">Recipe Name</label><input type="text" name="name" id="edit-name" required class="mt-1 block w-full rounded-md bg-drysage text-gray-900 placeholder-gray-500 border-sand shadow-sm focus:border-sand focus:ring-sand"></div>
                    <div class="sm:col-span-2">
                        <label class="block text-sm font-medium text-drysage">Recipe Image</label>
                        <div class="mt-1 flex gap-2 items-center">
                            <input type="file" id="edit-image-input" accept="image/*" class="block w-full text-sm text-drysage file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-sand file:text-frostedmint hover:file:bg-sand/80">
                            <button type="button" id="edit-generate-btn" class="inline-flex items-center justify-center rounded-md border border-sand bg-drysage px-4 py-2 text-sm font-medium text-granite shadow-sm hover:bg-sand hover:text-frostedmint whitespace-nowrap">Generate AI ✨</button>
                        </div>
                        <input type="hidden" name="image_base64" id="edit-image-base64">
                        <div id="edit-image-preview-container" class="mt-2 hidden relative w-full h-48 bg-granite border border-sand rounded-md overflow-hidden">
                            <img id="edit-image-preview" class="w-full h-full object-cover opacity-80">
                            <button type="button" id="edit-remove-image" class="absolute top-2 right-2 bg-darkraspberry text-frostedmint rounded-full p-1 shadow-md hover:bg-opacity-80">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                            </button>
                        </div>
                    </div>
                    <div><label for="edit-prep_time" class="block text-sm font-medium text-drysage">Prep Time (mins)</label><input type="number" name="prep_time" id="edit-prep_time" class="mt-1 block w-full rounded-md bg-drysage text-gray-900 placeholder-gray-500 border-sand shadow-sm focus:border-sand focus:ring-sand"></div>
                    <div><label for="edit-cook_time" class="block text-sm font-medium text-drysage">Cook Time (mins)</label><input type="number" name="cook_time" id="edit-cook_time" class="mt-1 block w-full rounded-md bg-drysage text-gray-900 placeholder-gray-500 border-sand shadow-sm focus:border-sand focus:ring-sand"></div>
                    <div class="sm:col-span-2"><label for="edit-servings" class="block text-sm font-medium text-drysage">Servings</label><input type="number" name="servings" id="edit-servings" class="mt-1 block w-full rounded-md bg-drysage text-gray-900 placeholder-gray-500 border-sand shadow-sm focus:border-sand focus:ring-sand"></div>
                    <div class="sm:col-span-2"><label for="edit-instructions" class="block text-sm font-medium text-drysage">Instructions</label><textarea name="instructions" id="edit-instructions" rows="6" required class="mt-1 block w-full rounded-md bg-drysage text-gray-900 placeholder-gray-500 border-sand shadow-sm focus:border-sand focus:ring-sand"></textarea></div>
                </div>
            </form>
            <hr class="my-6 border-sand"><div class="ingredients-section"><h3 class="text-xl font-semibold text-frostedmint mb-4 font-serif">Ingredients</h3><div id="ingredients-list" class="space-y-2 mb-4"></div>
            <div id="add-ingredient-container" class="grid grid-cols-1 sm:grid-cols-3 gap-4 items-end p-4 bg-granite rounded-lg">
                <div class="sm:col-span-2"><label for="ingredient-name" class="block text-sm font-medium text-drysage">Ingredient Name</label><input type="text" id="ingredient-name" placeholder="e.g., Onion" required class="mt-1 block w-full rounded-md bg-drysage text-gray-900 placeholder-gray-500 border-sand shadow-sm focus:border-sand focus:ring-sand"></div>
                <div><label for="ingredient-quantity" class="block text-sm font-medium text-drysage">Quantity</label><input type="number" step="any" id="ingredient-quantity" placeholder="e.g., 2" required class="mt-1 block w-full rounded-md bg-drysage text-gray-900 placeholder-gray-500 border-sand shadow-sm focus:border-sand focus:ring-sand"></div>
                <div class="sm:col-span-3 text-right"><button type="button" id="add-ingredient-btn" class="inline-flex justify-center rounded-md border border-transparent bg-sand py-2 px-4 text-sm font-medium text-frostedmint shadow-sm hover:opacity-90">Add Ingredient</button></div>
            </div>
            </div>
            <div class="mt-8 flex justify-end gap-4"><button type="button" id="cancel-edit" class="rounded-md border border-sand bg-drysage text-granite py-2 px-4 text-sm font-medium shadow-sm hover:bg-sand hover:text-frostedmint">Cancel</button><button type="submit" form="edit-recipe-form" class="inline-flex justify-center rounded-md border border-transparent bg-sand py-2 px-4 text-sm font-medium text-frostedmint shadow-sm hover:opacity-90">Save Changes</button></div>
        </div>
    </div>
    <div id="select-recipe-modal" class="modal fixed inset-0 bg-black bg-opacity-60 hidden flex items-center justify-center p-4 z-50">
        <div class="bg-granite border border-sand rounded-2xl shadow-xl p-6 w-full max-w-md border border-sand">
            <h2 class="text-xl font-semibold text-frostedmint mb-4">Select a Recipe</h2>
            <div id="selectable-recipes-list" class="space-y-2 max-h-96 overflow-y-auto"></div>
            <button id="cancel-select-recipe" class="mt-4 w-full rounded-md border border-sand bg-drysage text-granite py-2 px-4 text-sm font-medium shadow-sm hover:bg-sand hover:text-frostedmint">Cancel</button>
        </div>
    </div>
    <div id="delete-confirm-modal" class="modal fixed inset-0 bg-black bg-opacity-60 hidden flex items-center justify-center p-4">
        <div class="bg-granite border border-sand rounded-2xl shadow-xl p-6 w-full max-w-md border border-sand">
            <h2 class="text-xl font-semibold text-frostedmint mb-2">Delete Recipe</h2>
            <p class="text-drysage mb-6">Are you sure you want to delete <span id="delete-recipe-name" class="font-bold text-frostedmint"></span>? This action cannot be undone.</p>
            <div class="flex justify-end gap-4">
                <button id="cancel-delete" class="rounded-md border border-sand bg-slate-600 py-2 px-4 text-sm font-medium text-frostedmint hover:bg-slate-500">Cancel</button>
                <button id="confirm-delete-btn" class="rounded-md border border-transparent bg-darkraspberry py-2 px-4 text-sm font-medium text-frostedmint hover:opacity-90">Delete</button>
            </div>
        </div>
    </div>


    <div id="view-recipe-modal" class="modal fixed inset-0 bg-black bg-opacity-60 hidden flex items-start justify-center p-4 overflow-y-auto z-50">
        <div class="bg-granite border border-sand rounded-2xl shadow-xl w-full max-w-3xl my-auto border border-sand overflow-hidden">
            <div id="view-recipe-header" class="relative h-64 w-full bg-drysage">
                <img id="view-recipe-image" class="w-full h-full object-cover">
                <div class="absolute inset-0 bg-gradient-to-t from-granite to-transparent"></div>
                <button id="close-view-modal" class="absolute top-4 right-4 bg-black/50 text-frostedmint rounded-full p-2 hover:bg-black/70 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
                <h2 id="view-recipe-name" class="absolute bottom-4 left-6 text-4xl font-pacifico text-frostedmint drop-shadow-md"></h2>
            </div>
            <div class="p-6 sm:p-8">
                <div class="flex flex-wrap gap-4 text-drysage mb-6 text-sm font-medium border-b border-sand pb-4">
                    <div class="flex items-center gap-1"><span class="text-sand">Prep:</span> <span id="view-prep-time"></span></div>
                    <div class="flex items-center gap-1"><span class="text-sand">Cook:</span> <span id="view-cook-time"></span></div>
                    <div class="flex items-center gap-1"><span class="text-sand">Total:</span> <span id="view-total-time"></span></div>
                    <div class="flex items-center gap-1 ml-auto"><span class="text-sand">Servings:</span> <span id="view-servings"></span></div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                    <div class="md:col-span-1">
                        <h3 class="text-xl font-serif text-sand mb-3">Ingredients</h3>
                        <ul id="view-ingredients-list" class="space-y-2 text-frostedmint text-sm"></ul>
                    </div>
                    <div class="md:col-span-2">
                        <h3 class="text-xl font-serif text-sand mb-3">Instructions</h3>
                        <div id="view-instructions" class="text-frostedmint leading-relaxed whitespace-pre-wrap"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="settings-modal" class="modal fixed inset-0 bg-black bg-opacity-80 hidden flex items-center justify-center p-4 z-50">
        <div class="bg-granite border border-sand rounded-2xl shadow-xl p-6 w-full max-w-md border border-sand">
            <h2 class="text-2xl font-semibold text-frostedmint mb-4 font-serif">App Setup</h2>
            <p class="text-drysage mb-4 text-sm">Connect to your Supabase project and log in to access your secure recipes.</p>
            
            <form id="settings-form" class="space-y-4">
                <div class="border-b border-sand pb-4 mb-4">
                    <h3 class="text-sand font-semibold mb-2 text-sm uppercase tracking-wide">1. Connection</h3>
                    <div class="space-y-2">
                        <div>
                            <label class="block text-xs font-medium text-drysage">Supabase URL</label>
                            <input type="text" name="supabase_url" id="setting-url" placeholder="https://xyz.supabase.co" class="mt-1 block w-full rounded-md bg-deepmoss text-frostedmint placeholder-granite/50 border-sand shadow-sm focus:border-sand focus:ring-sand p-2 text-sm">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-drysage">Supabase Anon Key</label>
                            <input type="password" name="supabase_key" id="setting-key" placeholder="eyJhbG..." class="mt-1 block w-full rounded-md bg-deepmoss text-frostedmint placeholder-granite/50 border-sand shadow-sm focus:border-sand focus:ring-sand p-2 text-sm">
                        </div>
                    </div>
                </div>

                <div>
                    <h3 class="text-sand font-semibold mb-2 text-sm uppercase tracking-wide">2. Authentication</h3>
                    <div class="space-y-2">
                        <div>
                            <label class="block text-xs font-medium text-drysage">Email</label>
                            <input type="email" name="email" id="auth-email" placeholder="you@example.com" class="mt-1 block w-full rounded-md bg-deepmoss text-frostedmint placeholder-granite/50 border-sand shadow-sm focus:border-sand focus:ring-sand p-2 text-sm">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-drysage">Password</label>
                            <input type="password" name="password" id="auth-password" placeholder="••••••••" class="mt-1 block w-full rounded-md bg-deepmoss text-frostedmint placeholder-granite/50 border-sand shadow-sm focus:border-sand focus:ring-sand p-2 text-sm">
                        </div>
                    </div>
                </div>

                <div id="auth-error" class="text-darkraspberry text-sm hidden font-bold"></div>

                <div class="flex justify-between items-center mt-6 pt-2">
                    <button type="button" id="cancel-settings" class="text-drysage hover:text-sand text-sm">Cancel</button>
                    <div class="flex gap-2">
                        <button type="button" id="btn-signup" class="rounded-md border border-sand bg-transparent text-frostedmint py-2 px-4 text-sm font-medium hover:bg-sand/20">Sign Up</button>
                        <button type="submit" id="btn-login" class="rounded-md border border-transparent bg-sand py-2 px-4 text-sm font-medium text-frostedmint shadow-sm hover:opacity-90">Log In</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

        let supabase;
        let recipesCache = [];
        let mealPlanCache = [];
        let currentEditingRecipeId = null;
        let currentMealSlotId = null;
        let recipeToDeleteId = null;
        let lastGeneratedShoppingMap = new Map();
        let manualShoppingItems = [];
        // Buffer for new recipe ingredients
        let newIngredientsBuffer = [];

        // UI Refs
        const navButtons = document.querySelectorAll('.nav-btn');
        // ... (rest of UI Refs)

        // ...

        function renderRecipes() {
            // ... (existing renderRecipes code)
        }

        function openAddModal() { 
            addModal.classList.remove('hidden'); 
            // Reset image state
            document.getElementById('add-image-input').value = '';
            document.getElementById('add-image-base64').value = '';
            document.getElementById('add-image-preview-container').classList.add('hidden');
            
            // Reset Ingredients Buffer
            newIngredientsBuffer = [];
            renderNewIngredientsBuffer();
            document.getElementById('add-ing-name').value = '';
            document.getElementById('add-ing-qty').value = '';
        }
        function closeAddModal() { document.getElementById('add-recipe-form').reset(); addModal.classList.add('hidden'); }

        // --- NEW INGREDIENT BUFFER LOGIC ---
        function renderNewIngredientsBuffer() {
            const list = document.getElementById('add-ingredients-list');
            list.innerHTML = '';
            if (newIngredientsBuffer.length === 0) { 
                list.innerHTML = `<p class="text-sm text-sand">No ingredients added yet.</p>`; 
                return; 
            }
            newIngredientsBuffer.forEach((item, index) => {
                const el = document.createElement('div');
                el.className = 'flex justify-between items-center bg-drysage text-granite placeholder-granite/70 p-2 rounded-md';
                el.innerHTML = `<p class="text-sm text-gray-900"><span>${item.name}</span> - ${item.quantity}</p>
                <button type="button" class="remove-buffer-btn text-gray-600 hover:text-darkraspberry" data-index="${index}">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                    </svg>
                </button>`;
                list.appendChild(el);
            });
            
            // Attach listeners to dynamic buttons
            list.querySelectorAll('.remove-buffer-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const idx = parseInt(e.currentTarget.dataset.index);
                    removeFromIngredientBuffer(idx);
                });
            });
        }

        function addToIngredientBuffer() {
            const nameInput = document.getElementById('add-ing-name');
            const qtyInput = document.getElementById('add-ing-qty');
            const name = nameInput.value.trim();
            const qty = parseFloat(qtyInput.value);

            if (!name || !qty) {
                alert("Please enter a name and quantity.");
                return;
            }

            newIngredientsBuffer.push({ name, quantity: qty });
            nameInput.value = '';
            qtyInput.value = '';
            nameInput.focus();
            renderNewIngredientsBuffer();
        }

        function removeFromIngredientBuffer(index) {
            newIngredientsBuffer.splice(index, 1);
            renderNewIngredientsBuffer();
        }

        document.getElementById('btn-add-ing-to-buffer').addEventListener('click', addToIngredientBuffer);


        async function handleAddFormSubmit(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            
            // Get base64 from hidden input (populated by file input or AI)
            const imageBase64 = document.getElementById('add-image-base64').value || null;

            const newRecipe = { 
                name: formData.get('name'), 
                instructions: formData.get('instructions'), 
                prep_time: parseInt(formData.get('prep_time')) || null, 
                cook_time: parseInt(formData.get('cook_time')) || null, 
                servings: parseInt(formData.get('servings')) || null,
                image_url: imageBase64 
            };
            
            try {
                // 1. Insert Recipe
                const { data: recipeData, error: recipeError } = await supabase.from('recipes').insert([newRecipe]).select().single();
                if (recipeError) throw recipeError;
                
                const newRecipeId = recipeData.id;

                // 2. Process Ingredients Buffer
                for (const item of newIngredientsBuffer) {
                    // Check if ingredient exists
                    let { data: existingIng } = await supabase.from('ingredients').select('id').eq('name', item.name).single();
                    let ingredientId;

                    if (existingIng) {
                        ingredientId = existingIng.id;
                    } else {
                        // Create new ingredient
                        const { data: newIng, error: ingError } = await supabase.from('ingredients').insert({ name: item.name }).select('id').single();
                        if (ingError) throw ingError;
                        ingredientId = newIng.id;
                    }

                    // Link to Recipe
                    const { error: linkError } = await supabase.from('recipe_ingredients').insert({
                        recipe_id: newRecipeId,
                        ingredient_id: ingredientId,
                        quantity: item.quantity
                    });
                    if (linkError) throw linkError;
                }

                closeAddModal();
                await fetchRecipes();
                renderRecipes();

            } catch (err) {
                console.error("Error creating recipe:", err);
                alert(`Error: ${err.message}`);
            }
        }
        
        async function openEditModal(recipe) {
            currentEditingRecipeId = recipe.id;
            document.getElementById('edit-id').value = recipe.id;
            document.getElementById('edit-name').value = recipe.name;
            document.getElementById('edit-prep_time').value = recipe.prep_time;
            document.getElementById('edit-cook_time').value = recipe.cook_time;
            document.getElementById('edit-servings').value = recipe.servings;
            document.getElementById('edit-instructions').value = recipe.instructions;
            
            // Image State
            const hiddenInput = document.getElementById('edit-image-base64');
            const previewContainer = document.getElementById('edit-image-preview-container');
            const previewImg = document.getElementById('edit-image-preview');
            
            document.getElementById('edit-image-input').value = ''; // Reset file input
            
            if (recipe.image_url) {
                hiddenInput.value = recipe.image_url;
                previewImg.src = recipe.image_url;
                previewContainer.classList.remove('hidden');
            } else {
                hiddenInput.value = '';
                previewContainer.classList.add('hidden');
            }
            
            editModal.classList.remove('hidden');
            await loadIngredientsForRecipe(recipe.id);
        }

        function closeEditModal() { editModal.classList.add('hidden'); }

        async function handleEditFormSubmit(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const recipeId = formData.get('id');

            const imageBase64 = document.getElementById('edit-image-base64').value || null;

            const updatedData = { 
                name: formData.get('name'), 
                instructions: formData.get('instructions'), 
                prep_time: parseInt(formData.get('prep_time')) || null, 
                cook_time: parseInt(formData.get('cook_time')) || null, 
                servings: parseInt(formData.get('servings')) || null,
                image_url: imageBase64
            };

            const { error } = await supabase.from('recipes').update(updatedData).eq('id', recipeId);
            if (error) { alert(`Error: ${error.message}`); } else {
                closeEditModal();
                await fetchRecipes();
                renderRecipes();
            }
        }

        // --- IMAGE HANDLING UTILS ---
        
        async function handleImageFileSelect(e, hiddenInputId, previewContainerId, previewImgId) {
            const file = e.target.files[0];
            if (!file) return;
            
            try {
                const base64 = await readFileAsBase64(file);
                document.getElementById(hiddenInputId).value = base64;
                document.getElementById(previewImgId).src = base64;
                document.getElementById(previewContainerId).classList.remove('hidden');
            } catch (err) {
                console.error("Error reading file:", err);
                alert("Failed to read image file.");
            }
        }

        async function handleGenerateImage(nameInputId, instructionsInputId, hiddenInputId, previewContainerId, previewImgId, btnId) {
            const name = document.getElementById(nameInputId).value.trim();
            const instructions = document.getElementById(instructionsInputId).value.trim();
            
            if (!name) {
                alert("Please enter a Recipe Name first.");
                return;
            }

            const btn = document.getElementById(btnId);
            const originalText = btn.textContent;
            btn.textContent = "Generating...";
            btn.disabled = true;

            // Simple prompt engineering
            const prompt = `Professional food photography of ${name}, ${instructions.substring(0, 50)}... appetizing, high resolution, 4k`;
            const encodedPrompt = encodeURIComponent(prompt);
            const url = `https://image.pollinations.ai/prompt/${encodedPrompt}?width=800&height=600&nologo=true`;

            try {
                // Fetch image as blob
                const response = await fetch(url);
                if (!response.ok) throw new Error("Generation failed");
                const blob = await response.blob();
                
                // Convert to base64
                const base64 = await readFileAsBase64(blob);
                
                document.getElementById(hiddenInputId).value = base64;
                document.getElementById(previewImgId).src = base64;
                document.getElementById(previewContainerId).classList.remove('hidden');
                
            } catch (err) {
                console.error("Image generation error:", err);
                alert("Could not generate image. Please try again.");
            } finally {
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }

        function handleRemoveImage(hiddenInputId, previewContainerId, fileInputId) {
            document.getElementById(hiddenInputId).value = '';
            document.getElementById(previewContainerId).classList.add('hidden');
            if(fileInputId) document.getElementById(fileInputId).value = '';
        }

        // Listeners for Image Controls
        document.getElementById('add-image-input').addEventListener('change', (e) => handleImageFileSelect(e, 'add-image-base64', 'add-image-preview-container', 'add-image-preview'));
        document.getElementById('edit-image-input').addEventListener('change', (e) => handleImageFileSelect(e, 'edit-image-base64', 'edit-image-preview-container', 'edit-image-preview'));
        
        document.getElementById('add-generate-btn').addEventListener('click', () => handleGenerateImage('add-name', 'add-instructions', 'add-image-base64', 'add-image-preview-container', 'add-image-preview', 'add-generate-btn'));
        document.getElementById('edit-generate-btn').addEventListener('click', () => handleGenerateImage('edit-name', 'edit-instructions', 'edit-image-base64', 'edit-image-preview-container', 'edit-image-preview', 'edit-generate-btn'));

        document.getElementById('add-remove-image').addEventListener('click', () => handleRemoveImage('add-image-base64', 'add-image-preview-container', 'add-image-input'));
        document.getElementById('edit-remove-image').addEventListener('click', () => handleRemoveImage('edit-image-base64', 'edit-image-preview-container', 'edit-image-input'));

        function openDeleteConfirmModal(recipeId, recipeName) {
            recipeToDeleteId = recipeId;
            document.getElementById('delete-recipe-name').textContent = recipeName;
            deleteConfirmModal.classList.remove('hidden');
        }

        function closeDeleteConfirmModal() {
            recipeToDeleteId = null;
            deleteConfirmModal.classList.add('hidden');
        }

        async function handleConfirmDelete() {
            if (!recipeToDeleteId) return;
            const { error } = await supabase.from('recipes').delete().eq('id', recipeToDeleteId);
            if (error) { alert(`Error: ${error.message}`); } else {
                closeDeleteConfirmModal();
                await fetchRecipes();
                renderRecipes();
            }
        }

        // --- INGREDIENT LOGIC ---
        async function loadIngredientsForRecipe(recipeId) {
            const list = document.getElementById('ingredients-list');
            list.innerHTML = `<p class="text-drysage">Loading...</p>`;
            const { data, error } = await supabase.from('recipe_ingredients').select('id, quantity, ingredients(name)').eq('recipe_id', recipeId);
            if(error) { console.error("Error loading ingredients:", error); list.innerHTML = `<p class="text-darkraspberry">Could not load ingredients.</p>`; return; }
            renderIngredients(data);
        }

        function renderIngredients(ingredients) {
            const list = document.getElementById('ingredients-list');
            list.innerHTML = '';
            if (ingredients.length === 0) { list.innerHTML = `<p class="text-sm text-sand">No ingredients added yet.</p>`; return; }
            ingredients.forEach(item => {
                const el = document.createElement('div');
                el.className = 'flex justify-between items-center bg-drysage text-granite placeholder-granite/70 p-2 rounded-md';
                el.innerHTML = `<p class="text-sm text-gray-900"><span>${item.ingredients.name}</span> - ${item.quantity}</p><button data-id="${item.id}" class="remove-ingredient-btn text-gray-600 hover:text-darkraspberry" title="Remove Ingredient">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                    </svg>
                </button>`;
                list.appendChild(el);
            });
        }

        async function handleAddIngredient() {
            const nameInput = document.getElementById('ingredient-name');
            const quantityInput = document.getElementById('ingredient-quantity');
            const name = nameInput.value.trim();
            const quantity = parseFloat(quantityInput.value);
            if (!name || !quantity || !currentEditingRecipeId) { alert('Please fill out all ingredient fields.'); return; }
            
            try {
                let { data: existing } = await supabase.from('ingredients').select('id').eq('name', name).single();
                let ingredientId;
                if (existing) {
                    ingredientId = existing.id;
                } else {
                    const { data: newIngredient, error } = await supabase.from('ingredients').insert({ name }).select('id').single();
                    if(error) throw error;
                    ingredientId = newIngredient.id;
                }

                const { error: linkError } = await supabase.from('recipe_ingredients').insert({ recipe_id: currentEditingRecipeId, ingredient_id: ingredientId, quantity });
                if(linkError) throw linkError;

                nameInput.value = '';
                quantityInput.value = '';
                await loadIngredientsForRecipe(currentEditingRecipeId);
            } catch(error) {
                console.error("Error adding ingredient:", error);
                alert("Could not add ingredient.");
            }
        }

        async function handleRemoveIngredient(recipeIngredientId) {
            const { error } = await supabase.from('recipe_ingredients').delete().eq('id', recipeIngredientId);
            if(error) { console.error("Error removing ingredient:", error); alert("Could not remove ingredient.");}
            else { await loadIngredientsForRecipe(currentEditingRecipeId); }
        }

        // --- MEAL PLANNER LOGIC ---
        const daysOfWeek = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"];
        const mealTypes = ["Breakfast", "Lunch", "Dinner"];

        async function fetchMealPlan() {
            const { data, error } = await supabase.from('meal_plan').select('*, recipes(name, servings, id)');
            if (error) {
                if (error.code === 'PGRST205') {
                    document.getElementById('meal-plan-grid').innerHTML = `<div class="md:col-span-8 col-span-1 bg-yellow-900 border border-yellow-700 text-yellow-200 p-4 rounded-lg"><p class="font-bold">Database Table Not Found</p><p>The 'meal_plan' table is missing. Please create it in Supabase with columns: <b>slot_id</b> (text) and <b>recipe_id</b> (int8, foreign key to recipes).</p></div>`;
                } else { console.error("Error fetching meal plan:", error); }
                mealPlanCache = null;
                return;
            }
            mealPlanCache = data;
        }

        function renderMealPlan() {
            const grid = document.getElementById('meal-plan-grid');
            if (!grid || mealPlanCache === null) return;
            grid.innerHTML = '';
            
            // Header Row: Label + Meal Types
            const headerRow = document.createElement('div');
            headerRow.className = "contents";
            // Responsive headers: smaller text on mobile
            headerRow.innerHTML = `<div class="p-1 md:p-2"></div>` + mealTypes.map(type => `<div class="font-bold text-center text-frostedmint p-1 md:p-2 text-xs md:text-xl">${type}</div>`).join('');
            grid.appendChild(headerRow);
            
            // Rows: Days
            daysOfWeek.forEach(day => {
                const dayRow = document.createElement('div');
                dayRow.className = "contents";
                
                // Row Label (Day Name) - Shortened on mobile
                let rowHTML = `<div class="font-bold text-center text-frostedmint p-1 md:p-2 flex items-center justify-center text-xs md:text-xl">
                    <span class="md:hidden">${day.substring(0, 3)}</span>
                    <span class="hidden md:block">${day}</span>
                </div>`;
                
                mealTypes.forEach(mealType => {
                    const slotId = `${day}-${mealType}`;
                    const planEntry = mealPlanCache.find(p => p.slot_id === slotId);
                    
                    const dropHandlers = `ondragover="event.preventDefault()"` ;
                    
                    // Reduced padding on mobile (p-1 vs p-2)
                    const bgColorClass = planEntry ? 'bg-deepmoss' : 'bg-transparent';
                    rowHTML += `<div class="meal-slot border border-sand rounded-md p-1 md:p-2 min-h-[80px] md:min-h-[120px] flex flex-col justify-between hover:bg-drysage text-granite placeholder-granite/70/50 transition-colors ${bgColorClass}" ${dropHandlers} data-slot-id="${slotId}">`;
                    
                    if (planEntry) {
                        const servings = planEntry.portions !== null && planEntry.portions !== undefined ? planEntry.portions : planEntry.recipes.servings;
                        const isDraggable = true;
                        const draggableAttr = 'draggable="true"';
                        const cursorClass = 'cursor-grab active:cursor-grabbing';
                        
                        // Smaller badge on mobile
                        const servingsDisplay = servings > 1 ? `<div class="flex justify-center mt-1 md:mt-3"><span class="flex items-center justify-center w-6 h-6 md:w-10 md:h-10 rounded-full bg-drysage text-granite placeholder-granite/70 border border-sand text-[10px] md:text-sm font-bold text-frostedmint shadow-inner">x${servings}</span></div>` : '';
                        
                        rowHTML += `<div ${draggableAttr} class="${cursorClass} h-full flex flex-col" data-plan-id="${planEntry.id}" data-recipe-id="${planEntry.recipes.id}" data-current-servings="${servings}">
                            <div><p class="font-semibold text-frostedmint leading-tight text-center text-[10px] md:text-base">${planEntry.recipes.name}</p>${servingsDisplay}</div>
                        </div>
                        <button data-id="${planEntry.id}" class="remove-from-plan-btn text-sand hover:text-darkraspberry self-end mt-[-15px] md:mt-[-20px] relative z-10" title="Remove from plan">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 md:h-4 md:w-4" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                            </svg>
                        </button>`;
                    } else {
                        rowHTML += `<button data-slot-id="${slotId}" class="add-to-plan-btn w-full h-full flex items-center justify-center text-xl md:text-3xl text-drysage hover:text-frostedmint rounded-md">+</button>`;
                    }
                    rowHTML += `</div>`;
                });
                dayRow.innerHTML = rowHTML;
                grid.appendChild(dayRow);
            });
            
            // Re-attach listeners for dynamic elements
            addDragListeners();
        }

        function addDragListeners() {
            const draggables = document.querySelectorAll('[draggable="true"]');
            const slots = document.querySelectorAll('.meal-slot');

            draggables.forEach(draggable => {
                draggable.addEventListener('dragstart', (e) => {
                    e.dataTransfer.setData('text/plain', JSON.stringify({
                        sourcePlanId: draggable.dataset.planId,
                        recipeId: draggable.dataset.recipeId,
                        sourceServings: parseInt(draggable.dataset.currentServings)
                    }));
                    e.dataTransfer.effectAllowed = 'move';
                    draggable.style.opacity = '0.5';
                });
                
                draggable.addEventListener('dragend', (e) => {
                     draggable.style.opacity = '1';
                });
            });

            slots.forEach(slot => {
                slot.addEventListener('drop', async (e) => {
                    e.preventDefault();
                    
                    const data = e.dataTransfer.getData('text/plain');
                    if (!data) return;
                    
                    const { sourcePlanId, recipeId, sourceServings } = JSON.parse(data);
                    const targetSlotId = slot.dataset.slotId;
                    
                    if (!targetSlotId || !sourcePlanId) return;

                    // Check content of target slot
                    const targetPlanEntry = mealPlanCache.find(p => p.slot_id === targetSlotId);

                    // Prevent dropping on self
                    if (targetPlanEntry && targetPlanEntry.id == sourcePlanId) return;

                    let targetAction = null; 

                    if (!targetPlanEntry) {
                        targetAction = 'create_or_move';
                    } else if (targetPlanEntry.recipes.id == recipeId) {
                        targetAction = 'merge';
                    } else {
                        return; // Different recipe, ignore
                    }

                    try {
                        if (sourceServings > 1) {
                            // SPLIT: Decrement source, increment/create target
                            const { error: updateError } = await supabase.from('meal_plan').update({ portions: sourceServings - 1 }).eq('id', sourcePlanId);
                            if (updateError) throw updateError;

                            if (targetAction === 'create_or_move') {
                                const { error: insertError } = await supabase.from('meal_plan').insert([{ slot_id: targetSlotId, recipe_id: recipeId, portions: 1 }]);
                                if (insertError) throw insertError;
                            } else {
                                const currentTargetPortions = targetPlanEntry.portions !== null ? targetPlanEntry.portions : targetPlanEntry.recipes.servings;
                                const { error: mergeError } = await supabase.from('meal_plan').update({ portions: (currentTargetPortions || 1) + 1 }).eq('id', targetPlanEntry.id);
                                if (mergeError) throw mergeError;
                            }
                        } else {
                            // MOVE: Move or Merge-and-Delete source
                            if (targetAction === 'create_or_move') {
                                const { error: moveError } = await supabase.from('meal_plan').update({ slot_id: targetSlotId }).eq('id', sourcePlanId);
                                if (moveError) throw moveError;
                            } else {
                                const currentTargetPortions = targetPlanEntry.portions !== null ? targetPlanEntry.portions : targetPlanEntry.recipes.servings;
                                const { error: mergeError } = await supabase.from('meal_plan').update({ portions: (currentTargetPortions || 1) + 1 }).eq('id', targetPlanEntry.id);
                                if (mergeError) throw mergeError;
                                
                                const { error: deleteError } = await supabase.from('meal_plan').delete().eq('id', sourcePlanId);
                                if (deleteError) throw deleteError;
                            }
                        }

                        await fetchMealPlan();
                        renderMealPlan();

                    } catch (err) {
                        console.error("Drag and drop failed:", err);
                        alert("Failed to move item.");
                        await fetchMealPlan();
                        renderMealPlan();
                    }
                });
            });
        }
        
        function openSelectRecipeModal(slotId) {
            currentMealSlotId = slotId;
            const list = document.getElementById('selectable-recipes-list');
            list.innerHTML = '';
            if (recipesCache.length === 0) { list.innerHTML = '<p class="text-drysage">No recipes to select.</p>'; }
            recipesCache.forEach(recipe => {
                const item = document.createElement('button');
                item.className = 'w-full text-left p-2 rounded-md text-frostedmint hover:bg-drysage hover:text-granite font-medium transition-colors';
                item.textContent = recipe.name;
                item.dataset.recipeId = recipe.id;
                list.appendChild(item);
            });
            selectRecipeModal.classList.remove('hidden');
        }

        function closeSelectRecipeModal() { selectRecipeModal.classList.add('hidden'); }

        async function handleAddToPlan(recipeId) {
            if (!currentMealSlotId || !recipeId) return;
            const { error } = await supabase.from('meal_plan').insert([{ slot_id: currentMealSlotId, recipe_id: recipeId }]);
            if (error) {
                console.error("Error adding to meal plan:", error);
                alert("Error: " + error.message);
            } else {
                await fetchMealPlan();
                renderMealPlan();
                closeSelectRecipeModal();
            }
        }

        async function handleRemoveFromPlan(planId) {
            const { error } = await supabase.from('meal_plan').delete().eq('id', planId);
            if (error) { console.error("Error removing from plan:", error); } else {
                await fetchMealPlan();
                renderMealPlan();
            }
        }
        
        // --- EVENT LISTENERS ---
        document.getElementById('open-add-modal-btn').addEventListener('click', openAddModal);
        document.getElementById('add-recipe-form').addEventListener('submit', handleAddFormSubmit);
        document.getElementById('cancel-add').addEventListener('click', closeAddModal);
        document.getElementById('edit-recipe-form').addEventListener('submit', handleEditFormSubmit);
        document.getElementById('cancel-edit').addEventListener('click', closeEditModal);
        document.getElementById('add-ingredient-btn').addEventListener('click', handleAddIngredient);
        
        document.getElementById('cancel-delete').addEventListener('click', closeDeleteConfirmModal);
        document.getElementById('confirm-delete-btn').addEventListener('click', handleConfirmDelete);
        document.getElementById('generate-shopping-btn').addEventListener('click', generateShoppingList);
        document.getElementById('clear-plan-btn').addEventListener('click', handleClearMealPlan);

        async function handleClearMealPlan() {
            if (!confirm("Are you sure you want to clear the entire meal plan for this week?")) return;
            
            const { error } = await supabase.from('meal_plan').delete().neq('id', 0); // Delete all rows
            if (error) {
                console.error("Error clearing meal plan:", error);
                alert("Could not clear meal plan.");
            } else {
                await fetchMealPlan();
                renderMealPlan();
            }
        }

        recipesListContainer.addEventListener('click', (e) => {
            const editBtn = e.target.closest('.edit-btn');
            const deleteBtn = e.target.closest('.delete-btn');
            if (editBtn) {
                const recipe = recipesCache.find(r => r.id == editBtn.dataset.id);
                if(recipe) openEditModal(recipe);
            }
            if (deleteBtn) {
                const recipe = recipesCache.find(r => r.id == deleteBtn.dataset.id);
                if (recipe) openDeleteConfirmModal(recipe.id, recipe.name);
            }
        });
        
        document.getElementById('ingredients-list').addEventListener('click', (e) => {
             if (e.target.closest('.remove-ingredient-btn')) {
                handleRemoveIngredient(e.target.closest('.remove-ingredient-btn').dataset.id);
            }
        });
        
        // --- SHOPPING LIST LOGIC ---
        async function generateShoppingList() {
            if (!mealPlanCache || mealPlanCache.length === 0) {
                alert("Your meal plan is empty!");
                return;
            }

            const shoppingMap = new Map(); // Name -> { quantity, unit (implied) }

            // 1. Get all recipe IDs from the meal plan
            const recipeIds = [...new Set(mealPlanCache.map(p => p.recipes.id))];

            // 2. Fetch ingredients for ALL these recipes in one go
            const { data: allIngredients, error } = await supabase
                .from('recipe_ingredients')
                .select('recipe_id, quantity, ingredients(name)')
                .in('recipe_id', recipeIds);

            if (error) {
                console.error("Error fetching ingredients for shopping list:", error);
                alert("Could not generate list.");
                return;
            }

            // 3. Aggregate
            mealPlanCache.forEach(planEntry => {
                const portions = planEntry.portions || planEntry.recipes.servings || 1;
                const originalServings = planEntry.recipes.servings || 1;
                const ratio = portions / originalServings;

                const entryIngredients = allIngredients.filter(ri => ri.recipe_id === planEntry.recipes.id);
                
                entryIngredients.forEach(ing => {
                    const name = ing.ingredients.name;
                    const amount = ing.quantity * ratio;
                    
                    if (shoppingMap.has(name)) {
                        shoppingMap.set(name, shoppingMap.get(name) + amount);
                    } else {
                        shoppingMap.set(name, amount);
                    }
                });
            });

            lastGeneratedShoppingMap = shoppingMap;
            renderShoppingList(shoppingMap);
            
            // Navigate to shopping page
            document.getElementById('nav-shopping').click();
        }

        function renderShoppingList(shoppingMap = lastGeneratedShoppingMap) {
            const container = document.getElementById('shopping-list-container');
            container.innerHTML = '';
            
            if (shoppingMap.size === 0 && manualShoppingItems.length === 0) {
                container.innerHTML = '<p class="text-drysage">No ingredients found.</p>';
                return;
            }

            // Generated Items
            const sortedIngredients = Array.from(shoppingMap.entries()).sort((a, b) => a[0].localeCompare(b[0]));
            sortedIngredients.forEach(([name, quantity]) => {
                const formattedQuantity = parseFloat(quantity.toFixed(2));
                appendShoppingItem(name, formattedQuantity, false);
            });

            // Manual Items
            if (manualShoppingItems.length > 0) {
                // Optional divider if we have both
                if (shoppingMap.size > 0) {
                    const divider = document.createElement('div');
                    divider.className = "border-t border-sand my-2";
                    container.appendChild(divider);
                }
                manualShoppingItems.forEach(item => {
                    appendShoppingItem(item, null, true);
                });
            }
        }

        function appendShoppingItem(name, quantity, isManual) {
            const container = document.getElementById('shopping-list-container');
            const el = document.createElement('div');
            el.className = 'flex items-center p-3 bg-granite border border-sand rounded-lg hover:bg-drysage/10 transition-colors cursor-pointer mb-2';
            
            el.onclick = (e) => {
                if (e.target.type !== 'checkbox' && e.target.tagName !== 'BUTTON') {
                    const cb = el.querySelector('input[type="checkbox"]');
                    cb.checked = !cb.checked;
                    cb.dispatchEvent(new Event('change'));
                }
            };

            const quantityHTML = quantity !== null ? `<span class="ml-auto font-mono text-sand font-bold">${quantity}</span>` : '<span class="ml-auto text-drysage text-sm">Manual</span>';
            const deleteBtn = isManual ? `<button class="ml-2 text-drysage hover:text-darkraspberry delete-manual-item">×</button>` : '';

            el.innerHTML = `
                <input type="checkbox" class="w-5 h-5 rounded border-sand text-sand focus:ring-sand bg-granite">
                <span class="ml-3 text-frostedmint text-lg select-none">${name}</span>
                ${quantityHTML}
                ${deleteBtn}
            `;
            
            const checkbox = el.querySelector('input');
            checkbox.addEventListener('change', () => {
                if (checkbox.checked) {
                    el.querySelector('span.text-frostedmint').classList.add('line-through', 'text-drysage');
                    el.querySelector('span.text-frostedmint').classList.remove('text-frostedmint');
                } else {
                    el.querySelector('span.line-through').classList.add('text-frostedmint');
                    el.querySelector('span.line-through').classList.remove('line-through', 'text-drysage');
                }
            });
            
            if (isManual) {
                el.querySelector('.delete-manual-item').addEventListener('click', (e) => {
                    e.stopPropagation();
                    removeManualItem(name);
                });
            }

            container.appendChild(el);
        }

        function handleAddManualItem(e) {
            e.preventDefault();
            const input = e.target.querySelector('input[name="item_name"]');
            const name = input.value.trim();
            if (name) {
                manualShoppingItems.push(name);
                input.value = '';
                // Optimistically append to avoid full re-render (which kills check state)
                // Actually, renderShoppingList redraws everything, killing check state.
                // For a proper app we need state for checks. For this prototype, re-render is safer for order, 
                // but annoying. Let's just append to DOM if we can, but we need to handle the "Empty" state removal.
                // Simplest: just call render. The user just added an item, they probably haven't checked much yet.
                renderShoppingList();
            }
        }

        function removeManualItem(name) {
            manualShoppingItems = manualShoppingItems.filter(i => i !== name);
            renderShoppingList();
        }

        document.getElementById('add-shopping-item-form').addEventListener('submit', handleAddManualItem);

        document.getElementById('meal-plan-grid').addEventListener('click', (e) => {
            const addBtn = e.target.closest('.add-to-plan-btn');
            const removeBtn = e.target.closest('.remove-from-plan-btn');
            
            // Check for clicking on a filled meal slot to view details
            const mealSlotContent = e.target.closest('[data-recipe-id]');
            
            if (addBtn) { 
                openSelectRecipeModal(addBtn.dataset.slotId); 
            } else if (removeBtn) { 
                handleRemoveFromPlan(removeBtn.dataset.id); 
            } else if (mealSlotContent) {
                // If we clicked the content (and not the remove button which is handled above)
                openViewModal(mealSlotContent.dataset.recipeId);
            }
        });

        document.getElementById('cancel-select-recipe').addEventListener('click', closeSelectRecipeModal);
        document.getElementById('selectable-recipes-list').addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON' && e.target.dataset.recipeId) {
                handleAddToPlan(e.target.dataset.recipeId);
            }
        });

        // --- DRAG SCROLL LOGIC ---
        let isDown = false;
        let startX;
        let scrollLeft;
        let velX = 0;
        let momentumID;
        let lastMouseX;

        recipesListContainer.addEventListener('mousedown', (e) => {
            if (e.target.closest('button')) return;
            isDown = true;
            recipesListContainer.classList.add('cursor-grabbing');
            recipesListContainer.classList.remove('cursor-grab');
            recipesListContainer.style.scrollSnapType = 'none'; // Disable snapping while dragging
            startX = e.pageX - recipesListContainer.offsetLeft;
            scrollLeft = recipesListContainer.scrollLeft;
            lastMouseX = e.pageX;
            cancelAnimationFrame(momentumID);
        });

        recipesListContainer.addEventListener('mouseleave', () => {
            if (!isDown) return;
            isDown = false;
            recipesListContainer.classList.remove('cursor-grabbing');
            recipesListContainer.classList.add('cursor-grab');
            recipesListContainer.style.scrollSnapType = 'x mandatory';
            beginMomentum();
        });

        recipesListContainer.addEventListener('mouseup', () => {
            if (!isDown) return;
            isDown = false;
            recipesListContainer.classList.remove('cursor-grabbing');
            recipesListContainer.classList.add('cursor-grab');
            recipesListContainer.style.scrollSnapType = 'x mandatory';
            beginMomentum();
        });

        recipesListContainer.addEventListener('mousemove', (e) => {
            if(!isDown) return;
            e.preventDefault();
            const x = e.pageX - recipesListContainer.offsetLeft;
            const walk = (x - startX);
            recipesListContainer.scrollLeft = scrollLeft - walk;
            
            // Calculate velocity
            velX = e.pageX - lastMouseX;
            lastMouseX = e.pageX;
        });

        function beginMomentum() {
            cancelAnimationFrame(momentumID);
            momentumID = requestAnimationFrame(momentumLoop);
        }

        function momentumLoop() {
            recipesListContainer.scrollLeft -= velX;
            velX *= 0.95; // Friction
            if (Math.abs(velX) > 0.5) {
                momentumID = requestAnimationFrame(momentumLoop);
            }
        }

        initApp();

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => console.log('Service Worker registered', reg))
                    .catch(err => console.error('Service Worker registration failed', err));
            });
        }
    </script>
</body>
</html>


